version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 20

blocks:
  - name: CI
    task:
      jobs:
        - name: Build
          parallelism: 20
          commands:
            - checkout
            - df -h
            - sudo tune2fs -m 1 /dev/mapper/semaphore--vm--vg-root
            - sudo rm -rf /usr/local/golang/
            - sudo rm -rf /home/semaphore/.phpbrew
            - sudo rm -rf /home/semaphore/.kerl
            - sudo rm -rf /home/semaphore/.sbt
            - sudo rm -rf /home/semaphore/.nvm
            - sudo rm -rf /home/semaphore/.npm
            - sudo rm -rf /home/semaphore/.kiex
            - sudo rm -rf /home/semaphore/.rustup
            - sudo rm -rf /home/semaphore/.stack
            - sudo rm -rf /home/semaphore/.stack
            - sudo rm -rf /usr/lib/jvm
            - sudo rm -rf /opt/*
            - >-
              echo '{ "registry-mirrors": [], "max-concurrent-downloads": 10 }' | sudo tee /etc/docker/daemon.json
            - sudo service docker restart
            - df -h
            - docker pull zephyrprojectrtos/ci:v0.9.1
            - df -h
            - >-
              docker run
              -e MATRIX_BUILDS=${SEMAPHORE_JOB_COUNT}
              -e HOME=/home/buildslave
              -e MATRIX_BUILD=${SEMAPHORE_JOB_INDEX}
              -v /home/semaphore/.toolbox:/home/buildslave/.toolbox
              -v /tmp:/tmp
              -v /var/run/docker.sock:/var/run/docker.sock
              -v /home/semaphore/.ssh:/home/buildslave/.ssh
              -v /home/semaphore/${SEMAPHORE_PROJECT_NAME}/:/home/buildslave/${SEMAPHORE_PROJECT_NAME}
              --user buildslave
              --privileged=true
              --tty
              --net=bridge
              --entrypoint /home/buildslave/${SEMAPHORE_PROJECT_NAME}/.semaphore/docker_run.sh zephyrprojectrtos/ci:v0.9.1
