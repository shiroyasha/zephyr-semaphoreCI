version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
blocks:
  - name: CI
    task:
      epilogue:
        always:
          commands:
            - df -h
      jobs:
        - name: Build
          parallelism: 10
          commands:
            - checkout
            - df -h
            - sudo tune2fs -m 1 /dev/mapper/semaphore--vm--vg-root
            - sudo rm -rf /usr/local/golang/
            - sudo rm -rf /home/semaphore/.phpbrew
            - sudo rm -rf /home/semaphore/.kerl
            - sudo rm -rf /home/semaphore/.sbt
            - sudo rm -rf /home/semaphore/.nvm
            - sudo rm -rf /home/semaphore/.npm
            - sudo rm -rf /home/semaphore/.kiex
            - sudo rm -rf /home/semaphore/.rustup
            - sudo rm -rf /home/semaphore/.stack
            - sudo rm -rf /home/semaphore/.stack
            - sudo rm -rf /usr/lib/jvm
            - sudo rm -rf /opt/*
            - df -h
            - >-
              docker run -e MATRIX_BUILDS=${SEMAPHORE_JOB_COUNT} -e
              HOME=/home/buildslave -e MATRIX_BUILD=${SEMAPHORE_JOB_INDEX} -v
              /home/semaphore/.toolbox:/home/buildslave/.toolbox -v /tmp:/tmp -v
              /var/run/docker.sock:/var/run/docker.sock -v
              /home/semaphore/.ssh:/home/buildslave/.ssh -v
              /home/semaphore/${SEMAPHORE_PROJECT_NAME}/:/home/buildslave/${SEMAPHORE_PROJECT_NAME}
              --user buildslave --privileged=true --tty --net=bridge
              --entrypoint
              /home/buildslave/${SEMAPHORE_PROJECT_NAME}/.semaphore/docker_run.sh
              zephyrprojectrtos/ci:v0.9.1
