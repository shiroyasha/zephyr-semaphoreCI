version: v1.0
name: Pipeline
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804

execution_time_limit:
  minutes: 40

blocks:
  - name: CI
    task:
      jobs:
        - name: Build
          parallelism: 5
          commands:
            - checkout
            - bash .semaphore/setup.sh
            - docker pull zephyrprojectrtos/ci:v0.9.1
            - >-
              docker run
              -e MATRIX_BUILDS=${SEMAPHORE_JOB_COUNT}
              -e HOME=/home/buildslave
              -e MATRIX_BUILD=${SEMAPHORE_JOB_INDEX}
              -v /home/semaphore/.toolbox:/home/buildslave/.toolbox
              -v /tmp:/tmp
              -v /var/run/docker.sock:/var/run/docker.sock
              -v /home/semaphore/.ssh:/home/buildslave/.ssh
              -v /home/semaphore/${SEMAPHORE_PROJECT_NAME}/:/home/buildslave/${SEMAPHORE_PROJECT_NAME}
              --user buildslave
              --privileged=true
              --tty
              --net=bridge
              --entrypoint /home/buildslave/${SEMAPHORE_PROJECT_NAME}/.semaphore/docker_run.sh zephyrprojectrtos/ci:v0.9.1
